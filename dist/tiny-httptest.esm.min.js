/*!
 2023 Jason Mulligan <jason.mulligan@avoidwork.com>
 @version 3.0.3
*/
import t from"node:http";import e from"node:https";import{URL as s}from"node:url";import{coerce as i}from"tiny-coerce";import{createRequire as o}from"node:module";const h=/GET\, HEAD\, OPTIONS/,r=/(, )?content-type(, )?/,n=/^(application\/(json|(x-)?javascript)|text\/(javascript|x-javascript|x-json))/,a=/\w+/,p=/^".*"$/,c=o(import.meta.url)("../package.json"),{homepage:d,version:u}=c,l=new Map,y=new Map,g=new Map;class f{constructor(t,e,i,o,h){const r=new s(t);this.body="",this.capture=new Set,this.etag=!1,this.expects=new Map,this.expects.set("status",0),this.expects.set("body",""),this.expects.set("headers",new Map),this.expects.set("values",new Map),this.headers={},this.options={body:o,hostname:r.hostname,method:e,path:`${r.pathname}${r.search}`,port:r.port,protocol:r.protocol,headers:i,timeout:h},this.options.headers["user-agent"]=`tiny-httptest bot/${u} (${d})`,r.username.trim().length>0&&(this.options.auth=`${r.username}:${r.password}`,this.options.headers.authorization=`Basic ${btoa(this.options.auth)}`),this.options.body&&this.send(this.options.body),this.jar=!1,this.req=null,this.res=null,this.reuse=new Set,this.status=0}captureHeader(t){return this.capture.has(t)||this.capture.add(t),this}cookies(t=!0){return this.jar=t,this}cors(t,e=!0){const s=t||this.options.hostname;return this.options.headers.origin=s,this.options.headers["access-control-request-headers"]="content-type",e&&(this.expectHeader("access-control-allow-methods",h),this.expectHeader("access-control-allow-origin",s),this.expectHeader("access-control-allow-credentials","true"),"OPTIONS"===this.options.method?this.expectHeader("access-control-allow-headers",r):this.expectHeader("access-control-expose-headers",r)),this}end(){return new Promise(((t,e)=>{const s=s=>{if(void 0!==s)e(s);else try{this.process(),t(this)}catch(t){e(t)}};if(this.req)s();else{const t=this.http1Request;if(this.jar){const t=l.get(`${this.options.hostname}:${this.options.port}`);t&&(this.options.headers.cookie=t)}if(this.etag){const t=g.get(`${this.options.hostname}:${this.options.port}${this.options.path}`);t&&(this.options.headers["if-none-match"]=t)}this.reuse.size>0&&this.reuse.forEach((t=>{y.has(t)&&(this.options.headers[t]=y.get(t))})),t.call(this).then((()=>s()),s)}}))}etags(t=!0){return this.etag=t,this}expectBody(t=a){return this.expects.set("body",t),this}expectHeader(t,e=a){return this.expects.get("headers").set(t.toLowerCase(),e),this}expectJson(){return this.options.headers.accept="application/json",this.expectHeader("content-type",n)}expectStatus(t=200){return this.expects.set("status",t),this}expectValue(t,e){return this.expectJson(),this.expects.get("values").set(t,e),this}http1Request(){return new Promise(((s,i)=>{this.req=("http:"===this.options.protocol?t:e).request(this.options,(t=>{this.res=t,t.setEncoding("utf8"),t.on("data",(t=>{this.body+=t})),t.on("end",s)})),this.req.on("error",i),this.options.body&&this.req.write(this.options.body),this.req.end()}))}json(t){return this.options.headers["content-type"]="application/json",void 0!==t&&this.send(t),this.expectJson()}process(){const t=this.expects.get("body"),e=this.expects.get("status");if(this.headers=this.res.headers,this.status=this.res.statusCode,e&&this.status!==e&&this.test(this.status,e,this.warning("status",this.status,e)),this.expects.get("headers").forEach(((t,e)=>this.test(t,this.headers[e],this.warning("header",t,i(this.headers[e]),e)))),this.body&&n.test(this.headers["content-type"]||""))try{this.body=JSON.parse(this.body)}catch(t){}return t&&this.test(t,this.body,this.warning("body",this.body,t)),this.expects.get("values").forEach(((t,e)=>this.test(t,this.body[e],this.warning("body",t,this.body[e])))),this.capture.size>0&&this.capture.forEach((t=>{void 0!==this.headers[t]&&y.set(t,this.headers[t])})),this.jar&&this.headers["set-cookie"]&&l.set(this.options.hostname+":"+this.options.port,this.headers["set-cookie"]),this.etag&&this.headers.etag&&g.set(this.options.hostname+":"+this.options.port+this.options.path,this.headers.etag),this}reuseHeader(t){return this.reuse.has(t)||this.reuse.add(t),this}send(t){let e=t;if("string"!==typeof t)try{e=JSON.stringify(e,null,0),this.options.headers["content-type"]||(this.options.headers["content-type"]="application/json")}catch(t){}else if(!1===p.test(e))try{e=JSON.stringify(e)}catch(t){}return this.options.body=e,this.options.headers["content-length"]=Buffer.byteLength(e),this}test(t,e,s){let i;if(t instanceof Function)try{i=!0===t(e)}catch(t){i=!1}else i=t instanceof RegExp?void 0!==t&&t.test(e):"object"==typeof t&&"object"==typeof e?JSON.stringify(t,null,0)===JSON.stringify(e,null,0):isNaN(t)||isNaN(e)?t===e:Number(t)===Number(e);if(!i)throw new Error(s);return this}warning(t,e,s,i){return`Unexpected ${t} value: ${e instanceof RegExp?`${e.toString()}.test(res.headers["${i}"])`:JSON.stringify(e)} !== ${e instanceof RegExp||JSON.stringify(s)}`}}function m({url:e="http://localhost",method:s="GET",body:i=null,headers:o={},timeout:h=3e4,http2:r=!1}={}){const n=s.toUpperCase();if(!1===t.METHODS.includes(n))throw new Error("Invalid HTTP method");return new f(e,n,o,i,h,r)}export{m as httptest};//# sourceMappingURL=tiny-httptest.esm.min.js.map
