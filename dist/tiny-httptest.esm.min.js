/*!
 2022 Jason Mulligan <jason.mulligan@avoidwork.com>
 @version 3.0.1
*/
import t from"node:http";import{URL as e}from"node:url";import{coerce as s}from"tiny-coerce";import{createRequire as i}from"node:module";const o=/GET\, HEAD\, OPTIONS/,h=/(, )?content-type(, )?/,r=/^(application\/(json|(x-)?javascript)|text\/(javascript|x-javascript|x-json))/,n=/\w+/,a=/^".*"$/,p=i(import.meta.url)("../package.json"),{homepage:c,version:d}=p,u=new Map,l=new Map,y=new Map;class g{constructor(t,s,i,o,h){const r=new e(t);this.body="",this.capture=new Set,this.etag=!1,this.expects=new Map,this.expects.set("status",0),this.expects.set("body",""),this.expects.set("headers",new Map),this.expects.set("values",new Map),this.headers={},this.options={body:o,hostname:r.hostname,method:s,path:`${r.pathname}${r.search}`,port:r.port,protocol:r.protocol,headers:i,timeout:h},this.options.headers["user-agent"]=`tiny-httptest bot/${d} (${c})`,r.username.trim().length>0&&(this.options.auth=`${r.username}:${r.password}`,this.options.headers.authorization=`Basic ${btoa(this.options.auth)}`),this.options.body&&this.send(this.options.body),this.jar=!1,this.req=null,this.res=null,this.reuse=new Set,this.status=0}captureHeader(t){return this.capture.has(t)||this.capture.add(t),this}cookies(t=!0){return this.jar=t,this}cors(t,e=!0){const s=t||this.options.hostname;return this.options.headers.origin=s,this.options.headers["access-control-request-headers"]="content-type",e&&(this.expectHeader("access-control-allow-methods",o),this.expectHeader("access-control-allow-origin",s),this.expectHeader("access-control-allow-credentials","true"),"OPTIONS"===this.options.method?this.expectHeader("access-control-allow-headers",h):this.expectHeader("access-control-expose-headers",h)),this}end(){return new Promise(((t,e)=>{const s=s=>{if(void 0!==s)e(s);else try{this.process(),t(this)}catch(t){e(t)}};if(this.req)s();else{const t=this.http1Request;if(this.jar){const t=u.get(`${this.options.hostname}:${this.options.port}`);t&&(this.options.headers.cookie=t)}if(this.etag){const t=y.get(`${this.options.hostname}:${this.options.port}${this.options.path}`);t&&(this.options.headers["if-none-match"]=t)}this.reuse.size>0&&this.reuse.forEach((t=>{l.has(t)&&(this.options.headers[t]=l.get(t))})),t.call(this).then((()=>s()),s)}}))}etags(t=!0){return this.etag=t,this}expectBody(t=n){return this.expects.set("body",t),this}expectHeader(t,e=n){return this.expects.get("headers").set(t.toLowerCase(),e),this}expectJson(){return this.options.headers.accept="application/json",this.expectHeader("content-type",r)}expectStatus(t=200){return this.expects.set("status",t),this}expectValue(t,e){return this.expectJson(),this.expects.get("values").set(t,e),this}http1Request(){return new Promise(((e,s)=>{this.req=t.request(this.options,(t=>{this.res=t,t.setEncoding("utf8"),t.on("data",(t=>{this.body+=t})),t.on("end",e)})),this.req.on("error",s),this.options.body&&this.req.write(this.options.body),this.req.end()}))}json(t){return this.options.headers["content-type"]="application/json",void 0!==t&&this.send(t),this.expectJson()}process(){const t=this.expects.get("body"),e=this.expects.get("status");if(this.headers=this.res.headers,this.status=this.res.statusCode,e&&this.status!==e&&this.test(this.status,e,this.warning("status",this.status,e)),this.expects.get("headers").forEach(((t,e)=>this.test(t,this.headers[e],this.warning("header",t,s(this.headers[e]),e)))),this.body&&r.test(this.headers["content-type"]||""))try{this.body=JSON.parse(this.body)}catch(t){}return t&&this.test(t,this.body,this.warning("body",this.body,t)),this.expects.get("values").forEach(((t,e)=>this.test(t,this.body[e],this.warning("body",t,this.body[e])))),this.capture.size>0&&this.capture.forEach((t=>{void 0!==this.headers[t]&&l.set(t,this.headers[t])})),this.jar&&this.headers["set-cookie"]&&u.set(this.options.hostname+":"+this.options.port,this.headers["set-cookie"]),this.etag&&this.headers.etag&&y.set(this.options.hostname+":"+this.options.port+this.options.path,this.headers.etag),this}reuseHeader(t){return this.reuse.has(t)||this.reuse.add(t),this}send(t){let e=t;if("string"!==typeof t)try{e=JSON.stringify(e,null,0),this.options.headers["content-type"]||(this.options.headers["content-type"]="application/json")}catch(t){}else if(!1===a.test(e))try{e=JSON.stringify(e)}catch(t){}return this.options.body=e,this.options.headers["content-length"]=Buffer.byteLength(e),this}test(t,e,s){let i;if(t instanceof Function)try{i=!0===t(e)}catch(t){i=!1}else i=t instanceof RegExp?void 0!==t&&t.test(e):"object"==typeof t&&"object"==typeof e?JSON.stringify(t,null,0)===JSON.stringify(e,null,0):isNaN(t)||isNaN(e)?t===e:Number(t)===Number(e);if(!i)throw new Error(s);return this}warning(t,e,s,i){return`Unexpected ${t} value: ${e instanceof RegExp?`${e.toString()}.test(res.headers["${i}"])`:JSON.stringify(e)} !== ${e instanceof RegExp||JSON.stringify(s)}`}}function f({url:e="http://localhost",method:s="GET",body:i=null,headers:o={},timeout:h=3e4,http2:r=!1}={}){const n=s.toUpperCase();if(!1===t.METHODS.includes(n))throw new Error("Invalid HTTP method");return new g(e,n,o,i,h,r)}export{f as httptest};//# sourceMappingURL=tiny-httptest.esm.min.js.map
